name: Backup Azure VM

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Nom de la VM Ã  sauvegarder'
        required: true
      resource_group:
        description: 'Groupe de ressources'
        required: true
      snapshot_name:
        description: 'Nom du snapshot (optionnel, auto si vide)'
        required: false
jobs:
  backup-vms:
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Resolve Resource Group
      id: rg
      run: |
        RG="${{ github.event.inputs.resource_group || 'myResourceGroup' }}"
        echo "rg=$RG" >> $GITHUB_OUTPUT
        echo "âœ… Resource Group: $RG"

    - name: List VMs
      id: vms
      run: |
        VM_LIST=$(az vm list \
          --resource-group ${{ steps.rg.outputs.rg }} \
          --query "[].name" -o tsv)

        if [ -z "$VM_LIST" ]; then
          echo "âŒ Aucune VM dans le resource group"
          exit 1
        fi

        echo "âœ… VMs trouvÃ©es:"
        echo "$VM_LIST"

        echo "list=$VM_LIST" >> $GITHUB_OUTPUT

    - name: Backup all VMs
      run: |
        set -e

        for VM in ${{ steps.vms.outputs.list }}; do
          echo "======================================"
          echo "ðŸ“€ Sauvegarde de la VM: $VM"

          DISK_ID=$(az vm show \
            --resource-group ${{ steps.rg.outputs.rg }} \
            --name $VM \
            --query "storageProfile.osDisk.managedDisk.id" -o tsv)

          SNAP_NAME="$VM-snapshot-$(date +%Y%m%d-%H%M%S)"

          az snapshot create \
            --resource-group ${{ steps.rg.outputs.rg }} \
            --name "$SNAP_NAME" \
            --source "$DISK_ID" \
            --output table

          echo "âœ… Snapshot crÃ©Ã©: $SNAP_NAME"
        done
