name: Backup Azure VM

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Nom de la VM'
        required: true
      resource_group:
        description: 'Resource Group exact'
        required: true
      snapshot_name:
        description: 'Nom du snapshot (optionnel)'
        required: false

jobs:
  backup-vm:
    runs-on: ubuntu-latest

    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Validate Resource Group
      run: |
        if ! az group show --name "${{ github.event.inputs.resource_group }}" > /dev/null 2>&1; then
          echo "❌ ERREUR : Resource group introuvable : ${{ github.event.inputs.resource_group }}"
          exit 1
        fi
        echo "✅ Resource group trouvé"

    - name: Validate VM existence
      run: |
        if ! az vm show \
          --resource-group "${{ github.event.inputs.resource_group }}" \
          --name "${{ github.event.inputs.vm_name }}" > /dev/null 2>&1; then

          echo "❌ ERREUR : VM '${{ github.event.inputs.vm_name }}' introuvable dans le groupe '${{ github.event.inputs.resource_group }}'"
          exit 1
        fi
        echo "✅ VM trouvée : ${{ github.event.inputs.vm_name }}"

    - name: Resolve Snapshot Name
      id: snap
      run: |
        if [ -z "${{ github.event.inputs.snapshot_name }}" ]; then
          NAME="${{ github.event.inputs.vm_name }}-snapshot-$(date +%Y%m%d-%H%M%S)"
        else
          NAME="${{ github.event.inputs.snapshot_name }}"
        fi
        echo "name=$NAME" >> $GITHUB_OUTPUT
        echo "✅ Nom du snapshot : $NAME"

    - name: Get OS Disk
      id: disk
      run: |
        DISK_ID=$(az vm show \
          --resource-group "${{ github.event.inputs.resource_group }}" \
          --name "${{ github.event.inputs.vm_name }}" \
          --query "storageProfile.osDisk.managedDisk.id" -o tsv)

        if [ -z "$DISK_ID" ]; then
          echo "❌ ERREUR : disque OS introuvable"
          exit 1
        fi

        echo "disk_id=$DISK_ID" >> $GITHUB_OUTPUT
        echo "✅ Disque OS trouvé : $(basename "$DISK_ID")"

    - name: Create Snapshot
      run: |
        az snapshot create \
          --resource-group "${{ github.event.inputs.resource_group }}" \
          --name "${{ steps.snap.outputs.name }}" \
          --source "${{ steps.disk.outputs.disk_id }}" \
          --output table

        echo "✅ Snapshot créé avec succès"
