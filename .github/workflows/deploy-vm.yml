name: Deploy Azure VM B1S

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Nom de la VM'
        required: true
        default: 'myLinuxVM'
      resource_group:
        description: 'Nom du groupe de ressources'
        required: true
        default: 'myResourceGroup'
      location:
        description: 'RÃ©gion Azure'
        required: true
        default: 'francecentral'
        type: choice
        options:
          - francecentral
          - francesouth
          - westeurope
          - northeurope

jobs:
  deploy-vm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ github.event.inputs.resource_group }} \
          --location ${{ github.event.inputs.location }}
    
    - name: Create VM B1S
      run: |
        az vm create \
          --resource-group ${{ github.event.inputs.resource_group }} \
          --name ${{ github.event.inputs.vm_name }} \
          --image Ubuntu2204 \
          --size Standard_B1s \
          --admin-username azureuser \
          --generate-ssh-keys \
          --public-ip-sku Standard \
          --output json > vm-output.json
    
    - name: Display VM Info
      run: |
        echo "âœ… VM crÃ©Ã©e avec succÃ¨s!"
        echo "ğŸ“ Nom: ${{ github.event.inputs.vm_name }}"
        echo "ğŸ“¦ Groupe de ressources: ${{ github.event.inputs.resource_group }}"
        echo "ğŸŒ RÃ©gion: ${{ github.event.inputs.location }}"
        echo "ğŸ’» Taille: Standard_B1s"
        PUBLIC_IP=$(cat vm-output.json | jq -r '.publicIpAddress')
        echo "ğŸŒ IP publique: $PUBLIC_IP"
        echo ""
        echo "Pour vous connecter:"
        echo "ssh azureuser@$PUBLIC_IP"